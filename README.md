## Usage

The Delegated Account Recovery Rigid Reusable Ruby (aka D.a.r.r.r.r. or "Darrrr") library is meant to be used as the plumbing in your rack application. All major operations should be a single call to the Darrrr library. This library assumes your secrets are stored in `ENV`. See "custom crypto" on configuring an HSM, for example.

Along with a fully featured library, a proof of concept application is provided in this repo.

![Gar? Darrrrr](http://i.imgur.com/9eGO9c3.jpg)

## Provider registration

In order to allow a site to act as a provider, it must be "registered" on boot to prevent unauthorized providers from managing tokens.

```ruby
# Only configure this if you are acting as a recovery provider
Darrrr.register_account_provider("https://github.com")

# Only configure this if you are acting as an account provider
Darrrr.register_recovery_provider("https://facebook.com")
```

## Configuration (account provider)

An account provider (e.g. GitHub) is someone who stores a token with someone else (a recovery provider e.g. Facebook) in order to grant access to an account.

In `config/initializers` or any location that is run during application setup, add a file:

```ruby
Darrrr::AccountProvider.configure do |config|
  config.signing_private_key = ENV["ACCOUNT_PROVIDER_PRIVATE_KEY"]
  config.symmetric_key = ENV["TOKEN_DATA_AES_KEY"]
  config.token_max_size = 8192
  config.tokensign_pubkeys_secp256r1 = [ENV["ACCOUNT_PROVIDER_PUBLIC_KEY"]]

  # Set this to your app's origin
  authority = "http://localhost:9292"
  config.issuer = authority

  # configure these to point to the corresponding endpoints in your app
  config.save_token_return = "#{authority}/account-provider/save-token-return"
  config.recover_account_return = "#{authority}/account-provider/recover-account-return"
  config.privacy_policy = "#{authority}/articles/github-privacy-statement/"
  config.icon_152px = "#{authority}/images/modules/logos_page/GitHub-Mark.png"
end
```

## Configuration (recovery provider)

A recovery provider (e.g. Facebook) is someone actually stores tokens generated by account providers (e.g. GitHub).

```ruby
Darrrr::RecoveryProvider.configure do |config|
  config.signing_private_key = ENV["RECOVERY_PROVIDER_PRIVATE_KEY"]
  config.countersign_pubkeys_secp256r1 = [ENV["RECOVERY_PROVIDER_PUBLIC_KEY"]]
  config.token_max_size = 8192

  # Set this to your app's origin
  authority = "http://localhost:9292"
  config.issuer = authority

  # configure these to point to the corresponding endpoints in your app
  config.save_token = "#{authority}/recovery-provider/save-token"
  config.recover_account = "#{authority}/recovery-provider/recover-account"
  config.privacy_policy = "#{authority}/articles/github-privacy-statement/"
  config.icon_152px = "#{authority}/images/modules/logos_page/GitHub-Mark.png"
end
```

### Configuration (meta)

The delegated recovery spec depends on publicly available endpoints serving standard configs. These responses can be cached but are not by default. To configure your cache store, provide the reference:

```ruby
Darrrr.cache = Dalli::Client.new('localhost:11211', options)
```

The spec disallows `http` URIs for basic security, but sometimes we don't have this setup locally.

```ruby
Darrrr.allow_unsafe_urls = true
```

## Server code implementation

I strongly suggest you read the specification, specifically section 3.1 (save-token) and 3.5 (recover account) as they contain the most dangerous operations.

**NOTE:** this is NOT meant to be a complete implementation, it is just the starting point. Crucial aspects such as authentication, audit logging, out of band notifications, and account provider persistence are not implemented.

* [Account Provider](controllers/account_provider_controller.rb) (save-token-return, recover-account-return)
* [Recovery Provider](controllers/recovery_provider_controller.rb) (save-token, recover-account)
* [Configuration endpoint](controllers/well_known_config_controller.rb) (`/.well-known/delegated-account-recovery/configuration`)

## Working with the example sinatra app

This gem comes with a working proof of concept. It allows you to store and recover one token at a time.

### Setup

Run `./script/server`

1. Visit `http://localhost:9292/account-provider`
  * (Optionally) Record the random number for verification
  * Click "connect to http://localhost:9292"
1. You'll see some debug information on the page.
  * Click "setup recovery".
1. If recovery setup was successful, click "Recovery Setup Successful"
1. Click the "recover now?" link
1. You'll see an intermediate page, where more debug information is presented. Click "recover token"
1. You should be sent back to your host
  * And see something like `Recovered data: <the secret from step 1>`

### Tests

Run `./script/test` to run all tests.

### Don't want to run `./script` entries?

See `script/setup` for the environment variables that need to be set.
